# Lightweight Avatar Chat - æ¶æ„æ–‡æ¡£

> ğŸ“š æ·±å…¥ç†è§£é¡¹ç›®æ¶æ„ã€æŠ€æœ¯æ ˆå’Œå®ç°åŸç†

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æŠ€æœ¯æ ˆè¯¦è§£](#æŠ€æœ¯æ ˆè¯¦è§£)
4. [æ ¸å¿ƒæ¨¡å—å®ç°](#æ ¸å¿ƒæ¨¡å—å®ç°)
5. [æ•°æ®æµä¸å¤„ç†æµç¨‹](#æ•°æ®æµä¸å¤„ç†æµç¨‹)
6. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## é¡¹ç›®æ¦‚è¿°

### ğŸ¯ é¡¹ç›®å®šä½
**Lightweight Avatar Chat** æ˜¯ä¸€ä¸ªä¸º CPU ä¼˜åŒ–çš„å®æ—¶ 2D æ•°å­—äººå¯¹è¯ç³»ç»Ÿï¼Œæ— éœ€ GPU å³å¯æµç•…è¿è¡Œã€‚

### ğŸ”‘ æ ¸å¿ƒç‰¹æ€§
- âœ… **çº¯ CPU è¿è¡Œ** - æ— éœ€ GPU æ”¯æŒ
- âœ… **å®æ—¶æµå¼å“åº”** - é¦–å­—å»¶è¿Ÿ 0.3-0.5 ç§’
- âœ… **æ¨¡å—åŒ–è®¾è®¡** - æ˜“äºæ‰©å±•å’Œç»´æŠ¤
- âœ… **æ™ºèƒ½å†…å­˜ç®¡ç†** - è‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢æ³„æ¼
- âœ… **ç›‘æ§ä¸å¯è§‚æµ‹æ€§** - å®æ—¶æ€§èƒ½æŒ‡æ ‡

### ğŸ“Š ç³»ç»Ÿè¦æ±‚
```
CPU: 4 æ ¸å¿ƒä»¥ä¸Š
å†…å­˜: 8GB ä»¥ä¸Š
Python: 3.11+
Node.js: 18+
æ“ä½œç³»ç»Ÿ: Windows/Linux/macOS
```

---

## æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·ç«¯                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  ä¸»ç•Œé¢      â”‚              â”‚  ç›‘æ§é¢æ¿     â”‚             â”‚
â”‚  â”‚  (3000)     â”‚              â”‚  (3001)      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                             â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â”‚ WebSocket                   â”‚ HTTP/WS
          â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Nginx åå‘ä»£ç†                          â”‚
â”‚                      (80/443)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI    â”‚ â”‚  å‰ç«¯é™æ€   â”‚ â”‚ ç›‘æ§é™æ€  â”‚ â”‚  Prometheus â”‚
â”‚   åç«¯æœåŠ¡    â”‚ â”‚   æ–‡ä»¶      â”‚ â”‚  æ–‡ä»¶     â”‚ â”‚  æŒ‡æ ‡æ”¶é›†   â”‚
â”‚   (8000)     â”‚ â”‚             â”‚ â”‚           â”‚ â”‚  (9090)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ è°ƒç”¨
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒå¤„ç†å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  VAD   â”‚â†’â”‚  ASR   â”‚â†’â”‚  LLM   â”‚â†’â”‚  TTS   â”‚â†’â”‚Avatarâ”‚â”‚
â”‚  â”‚ Handlerâ”‚  â”‚Handler â”‚  â”‚Handler â”‚  â”‚Handler â”‚  â”‚Handlerâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â†‘                                                    â”‚
â”‚       â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Session Manager                         â”‚   â”‚
â”‚  â”‚  - ä¼šè¯ç®¡ç†                                        â”‚   â”‚
â”‚  â”‚  - å†…å­˜æ§åˆ¶                                        â”‚   â”‚
â”‚  â”‚  - ç”Ÿå‘½å‘¨æœŸç®¡ç†                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ è°ƒç”¨
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Whisper  â”‚  â”‚   Edge   â”‚  â”‚  ç§æœ‰    â”‚  â”‚ MediaPipeâ”‚ â”‚
â”‚  â”‚   Model  â”‚  â”‚   TTS    â”‚  â”‚  LLM     â”‚  â”‚ äººè„¸æ£€æµ‹  â”‚ â”‚
â”‚  â”‚  (æœ¬åœ°)  â”‚  â”‚ (äº‘æœåŠ¡) â”‚  â”‚ (API)    â”‚  â”‚  (æœ¬åœ°)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚æ¶æ„

#### 1. **è¡¨ç°å±‚ (Presentation Layer)**
- **å‰ç«¯ç•Œé¢** - Vue 3 + TypeScript + Ant Design Vue
- **ç›‘æ§é¢æ¿** - Vue 3 + ECharts + Prometheus

#### 2. **ç½‘å…³å±‚ (Gateway Layer)**
- **Nginx** - åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€é™æ€æ–‡ä»¶æœåŠ¡
- **WebSocket Manager** - è¿æ¥ç®¡ç†ã€å¿ƒè·³æ£€æµ‹

#### 3. **åº”ç”¨å±‚ (Application Layer)**
- **FastAPI** - REST API å’Œ WebSocket æœåŠ¡
- **Session Manager** - ä¼šè¯ç®¡ç†å’Œèµ„æºæ§åˆ¶
- **Health Monitor** - å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§

#### 4. **ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)**
- **Handler æ¨¡å¼** - ç»Ÿä¸€çš„å¤„ç†å™¨æ¥å£
- **æµå¼å¤„ç†** - å®æ—¶å“åº”ä¼˜åŒ–
- **ç¼“å†²ç®¡ç†** - éŸ³è§†é¢‘ç¼“å†²é˜Ÿåˆ—

#### 5. **æ•°æ®è®¿é—®å±‚ (Data Access Layer)**
- **æ¨¡å‹åŠ è½½** - ONNXã€PyTorch æ¨¡å‹ç®¡ç†
- **æ–‡ä»¶ç³»ç»Ÿ** - é…ç½®ã€æ—¥å¿—ã€æ¨¡å‹æ–‡ä»¶
- **å¤–éƒ¨ API** - LLMã€TTS æœåŠ¡è°ƒç”¨

---

## æŠ€æœ¯æ ˆè¯¦è§£

### åç«¯æŠ€æœ¯æ ˆ

#### 1. **Web æ¡†æ¶ - FastAPI**

**é€‰æ‹©ç†ç”±**ï¼š
```python
âœ“ åŸç”Ÿå¼‚æ­¥æ”¯æŒ (asyncio)
âœ“ è‡ªåŠ¨ API æ–‡æ¡£ç”Ÿæˆ
âœ“ WebSocket æ”¯æŒ
âœ“ é«˜æ€§èƒ½ (åŸºäº Starlette å’Œ Pydantic)
âœ“ ç±»å‹æç¤ºå’ŒéªŒè¯
```

**å…³é”®ç”¨æ³•**ï¼š
```python
# å¼‚æ­¥ç«¯ç‚¹
@app.websocket("/ws/{session_id}")
async def websocket_endpoint(websocket: WebSocket, session_id: str):
    await websocket_manager.connect(websocket, session_id)
    # å®æ—¶åŒå‘é€šä¿¡

# ä¾èµ–æ³¨å…¥
from fastapi import Depends
def get_session_manager():
    return SessionManager()

@app.get("/api/status")
async def get_status(manager: SessionManager = Depends(get_session_manager)):
    return await manager.get_status()
```

#### 2. **è¯­éŸ³è¯†åˆ« - Faster-Whisper**

**æŠ€æœ¯åŸç†**ï¼š
```
OpenAI Whisper â†’ CTranslate2 ä¼˜åŒ– â†’ CPU åŠ é€Ÿ
- ä½¿ç”¨ int8 é‡åŒ–
- ä¼˜åŒ–çš„æ³¨æ„åŠ›æœºåˆ¶
- æ‰¹å¤„ç†æ”¯æŒ
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
åŸç‰ˆ Whisper (CPU):     ~15-20s (small æ¨¡å‹)
Faster-Whisper (CPU):   ~3-5s (small æ¨¡å‹)
æå‡: 4-5å€
```

**å®ç°ä»£ç **ï¼š
```python
from faster_whisper import WhisperModel

model = WhisperModel(
    "small",
    device="cpu",
    compute_type="int8",  # å…³é”®ï¼šint8 é‡åŒ–
    cpu_threads=4
)

segments, info = model.transcribe(
    audio_array,
    language="zh",
    vad_filter=True  # å†…ç½® VAD
)
```

#### 3. **è¯­éŸ³åˆæˆ - Edge TTS**

**æŠ€æœ¯åŸç†**ï¼š
```
å¾®è½¯ Azure TTS â†’ Edge æµè§ˆå™¨æ¥å£ â†’ å…è´¹è°ƒç”¨
- æ— éœ€ API Key
- é«˜è´¨é‡ç¥ç»ç½‘ç»œè¯­éŸ³
- æ”¯æŒ SSML
- å¤šè¯­è¨€å¤šéŸ³è‰²
```

**ä¼˜åŠ¿**ï¼š
```
âœ“ å®Œå…¨å…è´¹
âœ“ æ— éœ€è®¤è¯
âœ“ è´¨é‡æ¥è¿‘ä»˜è´¹æœåŠ¡
âœ“ ä½å»¶è¿Ÿ (~200ms)
```

**å®ç°ä»£ç **ï¼š
```python
import edge_tts

communicate = edge_tts.Communicate(
    text="ä½ å¥½ä¸–ç•Œ",
    voice="zh-CN-XiaoxiaoNeural",
    rate="+0%",
    pitch="+0Hz"
)

# æµå¼è·å–éŸ³é¢‘
audio_data = b""
async for chunk in communicate.stream():
    if chunk["type"] == "audio":
        audio_data += chunk["data"]
```

#### 4. **æ•°å­—äººé©±åŠ¨ - Wav2Lip + ONNX**

**æŠ€æœ¯åŸç†**ï¼š
```
Wav2Lip (PyTorch) â†’ ONNX è½¬æ¢ â†’ ONNX Runtime (CPU)
- å˜´å‹åŒæ­¥ç®—æ³•
- äººè„¸åŒºåŸŸæ£€æµ‹
- GAN ç”Ÿæˆç½‘ç»œ
```

**å…³é”®æ­¥éª¤**ï¼š
1. **Mel Spectrogram æå–**
```python
mel = librosa.feature.melspectrogram(
    y=audio,
    sr=16000,
    n_fft=800,
    hop_length=200,
    n_mels=80
)
```

2. **äººè„¸æ£€æµ‹ (MediaPipe)**
```python
face_detector = mp.solutions.face_detection.FaceDetection()
results = face_detector.process(rgb_image)
```

3. **ONNX æ¨ç†**
```python
outputs = onnx_session.run(
    None,
    {
        'audio': mel_input,  # (1, 1, 80, 16)
        'face': face_input   # (1, 1, 3, 96, 96)
    }
)
```

4. **è§†é¢‘ç¼–ç **
```python
# FFmpeg H.264 ç¼–ç 
ffmpeg -f rawvideo -vcodec rawvideo \
  -s 512x512 -pix_fmt bgr24 -r 25 -i - \
  -c:v libx264 -preset ultrafast \
  -tune zerolatency -crf 23 output.mp4
```

#### 5. **LLM é›†æˆ - OpenAI API**

**å…¼å®¹æ€§è®¾è®¡**ï¼š
```python
from openai import AsyncOpenAI

client = AsyncOpenAI(
    api_key=your_key,
    base_url="http://your-llm/v1"  # å…¼å®¹ä»»ä½• OpenAI æ ¼å¼ API
)

# æ”¯æŒçš„åç«¯ï¼š
# - OpenAI
# - Azure OpenAI
# - æœ¬åœ° LLM (vLLM, Text-generation-webui)
# - é€šä¹‰åƒé—®
# - æ–‡å¿ƒä¸€è¨€
# - ChatGLM
```

**æµå¼å“åº”**ï¼š
```python
stream = await client.chat.completions.create(
    model="your-model",
    messages=messages,
    stream=True  # å…³é”®ï¼šå¯ç”¨æµå¼
)

async for chunk in stream:
    if chunk.choices[0].delta.content:
        text = chunk.choices[0].delta.content
        # å®æ—¶è¿”å›ç»™ç”¨æˆ·
```

#### 6. **VAD - Silero VAD**

**æŠ€æœ¯åŸç†**ï¼š
```
LSTM ç½‘ç»œ â†’ è¯­éŸ³æ´»åŠ¨æ£€æµ‹ â†’ PyTorch JIT
- å•æ¨¡å‹å¤šè¯­è¨€
- ä½å»¶è¿Ÿ (~10ms)
- é«˜å‡†ç¡®ç‡
```

**çŠ¶æ€æœºè®¾è®¡**ï¼š
```python
çŠ¶æ€è½¬æ¢ï¼š
é™é»˜ â†’ [æ£€æµ‹åˆ°è¯­éŸ³] â†’ å¯èƒ½æ˜¯è¯­éŸ³ 
    â†’ [æŒç»­ 250ms] â†’ ç¡®å®šæ˜¯è¯­éŸ³
    â†’ [æ£€æµ‹åˆ°é™é»˜] â†’ å¯èƒ½ç»“æŸ
    â†’ [æŒç»­ 500ms] â†’ ç¡®å®šç»“æŸ â†’ è¿”å›å®Œæ•´è¯­éŸ³
```

### å‰ç«¯æŠ€æœ¯æ ˆ

#### 1. **æ¡†æ¶ - Vue 3**

**æ ¸å¿ƒç‰¹æ€§**ï¼š
```javascript
âœ“ Composition API - æ›´å¥½çš„é€»è¾‘å¤ç”¨
âœ“ Reactivity System - å“åº”å¼ç³»ç»Ÿ
âœ“ TypeScript æ”¯æŒ
âœ“ æ€§èƒ½æå‡ - Proxy ä»£ç†
```

**ç»„ä»¶æ¶æ„**ï¼š
```
App.vue
â”œâ”€â”€ ChatView.vue (ä¸»ç•Œé¢)
â”‚   â”œâ”€â”€ useWebSocket (WebSocket è¿æ¥)
â”‚   â”œâ”€â”€ useAudioRecorder (éŸ³é¢‘å½•åˆ¶)
â”‚   â””â”€â”€ useChatStore (çŠ¶æ€ç®¡ç†)
â””â”€â”€ SettingsView.vue (è®¾ç½®é¡µé¢)
```

#### 2. **UI æ¡†æ¶ - Ant Design Vue**

**é€‰æ‹©ç†ç”±**ï¼š
```
âœ“ ä¼ä¸šçº§ UI ç»„ä»¶
âœ“ å®Œæ•´çš„ TypeScript æ”¯æŒ
âœ“ å›½é™…åŒ–æ”¯æŒ
âœ“ ä¸»é¢˜å®šåˆ¶
```

#### 3. **çŠ¶æ€ç®¡ç† - Pinia**

**å¯¹æ¯” Vuex**ï¼š
```javascript
// Pinia - æ›´ç®€æ´
export const useChatStore = defineStore('chat', () => {
  const messages = ref([])
  const addMessage = (msg) => messages.value.push(msg)
  return { messages, addMessage }
})

// Vuex - æ›´ç¹ç
{
  state: { messages: [] },
  mutations: {
    ADD_MESSAGE(state, msg) { state.messages.push(msg) }
  },
  actions: {
    addMessage({ commit }, msg) { commit('ADD_MESSAGE', msg) }
  }
}
```

#### 4. **æ„å»ºå·¥å…· - Vite**

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
```
ä¼ ç»Ÿæ‰“åŒ… (Webpack):  å†·å¯åŠ¨ 30-60s
Vite:                å†·å¯åŠ¨ <2s

åŸç†ï¼š
- ES Module åŸç”Ÿæ”¯æŒ
- æŒ‰éœ€ç¼–è¯‘
- æ™ºèƒ½é¢„æ„å»º
```

#### 5. **WebSocket é€šä¿¡**

**åŒåè®®è®¾è®¡**ï¼š
```javascript
// JSON æ¶ˆæ¯
websocket.send(JSON.stringify({
  type: 'text',
  text: 'Hello',
  streaming: true
}))

// äºŒè¿›åˆ¶æ¶ˆæ¯ (è§†é¢‘)
websocket.send(videoBlob)

// è‡ªåŠ¨åˆ†å‘
ws.onmessage = (event) => {
  if (event.data instanceof Blob) {
    handleBinary(event.data)  // è§†é¢‘
  } else {
    handleJSON(JSON.parse(event.data))  // æ–‡æœ¬
  }
}
```

---

## æ ¸å¿ƒæ¨¡å—å®ç°

### 1. Handler æ¨¡å¼è®¾è®¡

**åŸºç±»å®šä¹‰**ï¼š
```python
class BaseHandler(ABC):
    def __init__(self, config: Optional[Dict] = None):
        self.config = config or {}
        self._initialized = False
    
    async def initialize(self):
        """å»¶è¿ŸåŠ è½½ï¼ŒèŠ‚çœèµ„æº"""
        if not self._initialized:
            await self._setup()
            self._initialized = True
    
    @abstractmethod
    async def _setup(self):
        """å­ç±»å®ç°å…·ä½“çš„åˆå§‹åŒ–é€»è¾‘"""
        pass
    
    @abstractmethod
    async def process(self, data: Any) -> Any:
        """ç»Ÿä¸€çš„å¤„ç†æ¥å£"""
        pass
```

**ç»§æ‰¿ç»“æ„**ï¼š
```
BaseHandler
â”œâ”€â”€ SileroVADHandler       # è¯­éŸ³æ´»åŠ¨æ£€æµ‹
â”œâ”€â”€ WhisperHandler         # è¯­éŸ³è¯†åˆ«
â”œâ”€â”€ OpenAIHandler          # LLM å¯¹è¯
â”œâ”€â”€ EdgeTTSHandler         # è¯­éŸ³åˆæˆ
â””â”€â”€ Wav2LipHandler         # æ•°å­—äººç”Ÿæˆ
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºæ‰©å±•
- âœ… å»¶è¿Ÿåˆå§‹åŒ–ï¼ŒèŠ‚çœå†…å­˜
- âœ… é…ç½®çƒ­æ›´æ–°
- âœ… èµ„æºè‡ªåŠ¨æ¸…ç†

### 2. Session Manager - ä¼šè¯ç®¡ç†

**æ ¸å¿ƒèŒè´£**ï¼š
```python
class SessionManager:
    """
    1. ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
    2. å†…å­˜ä½¿ç”¨æ§åˆ¶
    3. è¶…æ—¶æ¸…ç†
    4. å¹¶å‘é™åˆ¶
    """
```

**å†…å­˜æ§åˆ¶ç­–ç•¥**ï¼š
```python
async def check_memory(self):
    process = psutil.Process()
    memory_mb = process.memory_info().rss / 1024 / 1024
    
    if memory_mb > self.max_memory_mb:
        # æ¸…ç†æœ€ä¹…æœªæ´»åŠ¨çš„ä¼šè¯
        await self.cleanup_old_sessions()
        
        # å¼ºåˆ¶åƒåœ¾å›æ”¶
        import gc
        gc.collect()
```

**ä¼šè¯éš”ç¦»**ï¼š
```python
æ¯ä¸ªä¼šè¯ç‹¬ç«‹æ‹¥æœ‰ï¼š
- ç‹¬ç«‹çš„ Handler å®ä¾‹
- ç‹¬ç«‹çš„å¯¹è¯å†å²
- ç‹¬ç«‹çš„ç¼“å†²åŒº
- ç‹¬ç«‹çš„é…ç½®

ä¼˜åŠ¿ï¼š
- é¿å…çŠ¶æ€æ±¡æŸ“
- æ”¯æŒå¹¶å‘å¤„ç†
- å•ä¼šè¯å´©æºƒä¸å½±å“å…¶ä»–ä¼šè¯
```

### 3. æµå¼å¤„ç†å®ç°

**æ ¸å¿ƒæ€æƒ³**ï¼š
```
ä¼ ç»Ÿæ¨¡å¼ï¼š
ç”¨æˆ·è¾“å…¥ â†’ LLMå®Œæ•´å“åº” â†’ TTSå®Œæ•´åˆæˆ â†’ Avatarå®Œæ•´ç”Ÿæˆ â†’ è¿”å›
å»¶è¿Ÿï¼š1.5-2ç§’

æµå¼æ¨¡å¼ï¼š
ç”¨æˆ·è¾“å…¥ â†’ LLMæµå¼è¾“å‡º â”€â”¬â†’ å¥å­1 â†’ TTS â†’ Avatar â†’ è¿”å›
                        â”œâ†’ å¥å­2 â†’ TTS â†’ Avatar â†’ è¿”å›
                        â””â†’ å¥å­3 â†’ TTS â†’ Avatar â†’ è¿”å›
å»¶è¿Ÿï¼š0.3-0.5ç§’ï¼ˆé¦–å¥ï¼‰
```

**å®ç°ä»£ç **ï¼š
```python
async def process_text_stream(self, text: str, callback):
    full_response = ""
    sentence_buffer = ""
    
    # æµå¼è·å– LLM å“åº”
    async for chunk in self.llm_handler.stream_response(text):
        full_response += chunk
        sentence_buffer += chunk
        
        # å®æ—¶å‘é€æ–‡æœ¬ç‰‡æ®µ
        await callback("text_chunk", {"chunk": chunk})
        
        # æ£€æµ‹å¥å­ç»“æŸ
        if self._is_sentence_end(sentence_buffer):
            # å¼‚æ­¥å¤„ç†è¿™ä¸ªå¥å­ï¼ˆä¸é˜»å¡ï¼‰
            asyncio.create_task(
                self._process_sentence(sentence_buffer, callback)
            )
            sentence_buffer = ""

async def _process_sentence(self, sentence: str, callback):
    # å¹¶è¡Œå¤„ç† TTS å’Œ Avatar
    audio = await self.tts_handler.synthesize(sentence)
    video = await self.avatar_handler.generate(audio)
    
    # ç«‹å³è¿”å›
    await callback("video_chunk", {
        "video": video,
        "text": sentence
    })
```

**å¥å­æ£€æµ‹ç®—æ³•**ï¼š
```python
def _is_sentence_end(self, text: str) -> bool:
    # ä¸­è‹±æ–‡å¥å­åˆ†éš”ç¬¦
    delimiters = ['ã€‚', 'ï¼', 'ï¼Ÿ', '.', '!', '?', 'ï¼›', ';', '\n']
    
    return any(text.rstrip().endswith(d) for d in delimiters)
```

### 4. è§†é¢‘ç¼–ç ä¼˜åŒ–

**FFmpeg ç®¡é“ç¼–ç **ï¼š
```python
def _frames_to_mp4_ffmpeg(self, frames, fps):
    # æ„å»º FFmpeg å‘½ä»¤
    ffmpeg_cmd = [
        'ffmpeg',
        '-f', 'rawvideo',      # è¾“å…¥æ ¼å¼ï¼šåŸå§‹è§†é¢‘
        '-vcodec', 'rawvideo',
        '-s', '512x512',       # åˆ†è¾¨ç‡
        '-pix_fmt', 'bgr24',   # åƒç´ æ ¼å¼
        '-r', str(fps),        # å¸§ç‡
        '-i', '-',             # ä» stdin è¯»å–
        
        '-c:v', 'libx264',     # H.264 ç¼–ç 
        '-preset', 'ultrafast', # é€Ÿåº¦ä¼˜å…ˆ
        '-tune', 'zerolatency', # ä½å»¶è¿Ÿ
        '-crf', '23',          # è´¨é‡ç³»æ•°
        '-pix_fmt', 'yuv420p', # å…¼å®¹æ€§
        '-movflags', '+faststart', # æµå¼ä¼˜åŒ–
        
        '-f', 'mp4',
        'pipe:1'               # è¾“å‡ºåˆ° stdout
    ]
    
    # åˆ›å»ºå­è¿›ç¨‹
    process = subprocess.Popen(
        ffmpeg_cmd,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    
    # æµå¼å†™å…¥å¸§æ•°æ®
    for frame in frames:
        process.stdin.write(frame.tobytes())
    
    # è·å–ç¼–ç åçš„ MP4
    video_bytes, _ = process.communicate()
    return video_bytes
```

**å‹ç¼©æ•ˆæœ**ï¼š
```
åŸå§‹å¸§æ•°æ®: 512*512*3*250 = 196MB (10ç§’ 25fps)
OpenCV ç¼–ç : ~8-10MB
FFmpeg H.264: ~2MB
å‹ç¼©ç‡: 98%
```

### 5. WebSocket åŒåè®®å®ç°

**åç«¯ - å‘é€é€»è¾‘**ï¼š
```python
# 1. å…ˆå‘é€å…ƒæ•°æ®ï¼ˆJSONï¼‰
await websocket.send_json({
    "type": "video_chunk_meta",
    "data": {
        "text": "ä½ å¥½",
        "size": len(video_bytes)
    }
})

# 2. å†å‘é€äºŒè¿›åˆ¶æ•°æ®
await websocket.send_bytes(video_bytes)
```

**å‰ç«¯ - æ¥æ”¶é€»è¾‘**ï¼š
```javascript
ws.onmessage = (event) => {
  // è‡ªåŠ¨è¯†åˆ«æ¶ˆæ¯ç±»å‹
  if (event.data instanceof Blob) {
    // äºŒè¿›åˆ¶ = è§†é¢‘
    handleVideoChunk(event.data)
  } else {
    // æ–‡æœ¬ = JSON
    const data = JSON.parse(event.data)
    handleMessage(data)
  }
}
```

**è§†é¢‘é˜Ÿåˆ—æ’­æ”¾**ï¼š
```javascript
const videoQueue = ref([])
const isPlaying = ref(false)

function handleVideoChunk(blob) {
  videoQueue.value.push(blob)
  
  if (!isPlaying.value) {
    playNextVideo()
  }
}

async function playNextVideo() {
  if (videoQueue.value.length === 0) {
    isPlaying.value = false
    return
  }
  
  isPlaying.value = true
  const videoBlob = videoQueue.value.shift()
  const url = URL.createObjectURL(videoBlob)
  
  videoElement.src = url
  await videoElement.play()
  
  videoElement.onended = () => {
    URL.revokeObjectURL(url)  // é‡Šæ”¾å†…å­˜
    playNextVideo()             // æ’­æ”¾ä¸‹ä¸€ä¸ª
  }
}
```

---

## æ•°æ®æµä¸å¤„ç†æµç¨‹

### å®Œæ•´å¯¹è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¯´è¯ (æˆ–è¾“å…¥æ–‡å­—)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯å½•éŸ³ / æ–‡æœ¬è¾“å…¥                                   â”‚
â”‚    - navigator.mediaDevices.getUserMedia()             â”‚
â”‚    - éŸ³é¢‘ç¼–ç  (WebM/PCM)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ WebSocket
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åç«¯æ¥æ”¶                                             â”‚
â”‚    - WebSocket.receive_json()                          â”‚
â”‚    - è·¯ç”±åˆ°å¯¹åº” Session                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. VAD æ£€æµ‹ (ä»…è¯­éŸ³è¾“å…¥)                                â”‚
â”‚    - Silero VAD åˆ¤æ–­æ˜¯å¦æœ‰è¯­éŸ³                           â”‚
â”‚    - ç´¯ç§¯éŸ³é¢‘ç¼“å†²åŒº                                      â”‚
â”‚    - æ£€æµ‹é™é»˜ç»“æŸè¯­éŸ³                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ASR è¯­éŸ³è¯†åˆ« (ä»…è¯­éŸ³è¾“å…¥)                            â”‚
â”‚    - Faster-Whisper è½¬å½•                                â”‚
â”‚    - int8 é‡åŒ–åŠ é€Ÿ                                       â”‚
â”‚    - è¾“å‡ºæ–‡æœ¬                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. LLM ç”Ÿæˆå›å¤ (æµå¼)                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚ async for chunk in llm.stream():     â”‚           â”‚
â”‚    â”‚   â”œâ†’ å‘é€ text_chunk ç»™å‰ç«¯           â”‚           â”‚
â”‚    â”‚   â””â†’ ç´¯ç§¯åˆ° sentence_buffer          â”‚           â”‚
â”‚    â”‚                                      â”‚           â”‚
â”‚    â”‚ æ£€æµ‹å¥å­ç»“æŸ (ã€‚ï¼ï¼Ÿ)                  â”‚           â”‚
â”‚    â”‚   â””â†’ è§¦å‘ TTS + Avatar ç”Ÿæˆ           â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å¹¶è¡Œå¤„ç†æ¯ä¸ªå¥å­
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. TTS è¯­éŸ³åˆæˆ                                         â”‚
â”‚    - Edge TTS åˆæˆéŸ³é¢‘                                   â”‚
â”‚    - MP3 æ ¼å¼è¾“å‡º                                        â”‚
â”‚    - è€—æ—¶ ~100-200ms                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Mel Spectrogram æå–                                 â”‚
â”‚    - librosa.feature.melspectrogram()                  â”‚
â”‚    - 80 mel bins Ã— 16 time steps                       â”‚
â”‚    - å½’ä¸€åŒ–åˆ° [0, 1]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. æ•°å­—äººè§†é¢‘ç”Ÿæˆ                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚ For each mel chunk:                  â”‚           â”‚
â”‚    â”‚   1. åŠ è½½æ¨¡æ¿å¸§                        â”‚           â”‚
â”‚    â”‚   2. MediaPipe æ£€æµ‹äººè„¸                â”‚           â”‚
â”‚    â”‚   3. è£å‰ªäººè„¸åŒºåŸŸ                      â”‚           â”‚
â”‚    â”‚   4. ONNX æ¨ç† (mel + face â†’ lip)     â”‚           â”‚
â”‚    â”‚   5. èåˆå›åŸå›¾                        â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚    - è¾“å‡ºå¸§åºåˆ—                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. è§†é¢‘ç¼–ç                                             â”‚
â”‚     - FFmpeg H.264 ç¼–ç                                  â”‚
â”‚     - ultrafast preset                                 â”‚
â”‚     - å‹ç¼©ç‡ 96%                                         â”‚
â”‚     - è¾“å‡º MP4 bytes                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. è¿”å›ç»™å‰ç«¯                                          â”‚
â”‚     1. å‘é€å…ƒæ•°æ® (JSON)                                â”‚
â”‚        {"type": "video_chunk_meta", "size": XXX}       â”‚
â”‚     2. å‘é€è§†é¢‘ (Binary)                                â”‚
â”‚        WebSocket.send_bytes(video_mp4)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. å‰ç«¯æ’­æ”¾                                            â”‚
â”‚     1. æ¥æ”¶ Blob                                        â”‚
â”‚     2. createObjectURL                                 â”‚
â”‚     3. åŠ å…¥æ’­æ”¾é˜Ÿåˆ—                                      â”‚
â”‚     4. è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ª                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶åºå›¾

```
ç”¨æˆ·    å‰ç«¯    åç«¯    LLM     TTS    Avatar
 â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
 â”œâ”€â”€è¯´è¯â”€â†’â”‚       â”‚       â”‚       â”‚       â”‚
 â”‚       â”œâ”€å½•éŸ³â”€â†’â”‚       â”‚       â”‚       â”‚
 â”‚       â”‚   WebSocket   â”‚       â”‚       â”‚
 â”‚       â”‚       â”œâ”€VADâ”€â”€â†’â”‚       â”‚       â”‚
 â”‚       â”‚       â”œâ”€ASRâ”€â”€â†’â”‚       â”‚       â”‚
 â”‚       â”‚       â”‚   "ä½ å¥½"      â”‚       â”‚
 â”‚       â”‚       â”œâ”€â”€â”€â”€â”€â”€â†’â”‚       â”‚       â”‚
 â”‚       â”‚       â”‚   æµå¼è¾“å‡º     â”‚       â”‚
 â”‚       â”‚       â”‚â†â”€"ä½ "â”€â”¤       â”‚       â”‚
 â”‚â†â”€æ˜¾ç¤ºâ”€â”¤â†chunkâ”€â”¤       â”‚       â”‚       â”‚
 â”‚   "ä½ " â”‚       â”‚       â”‚       â”‚       â”‚
 â”‚       â”‚       â”‚â†â”€"å¥½"â”€â”¤       â”‚       â”‚
 â”‚â†â”€æ˜¾ç¤ºâ”€â”¤â†chunkâ”€â”¤       â”‚       â”‚       â”‚
 â”‚  "å¥½"  â”‚       â”‚       â”‚       â”‚       â”‚
 â”‚       â”‚       â”‚â†â”€"ã€‚"â”€â”¤       â”‚       â”‚
 â”‚       â”‚       â”‚   æ£€æµ‹åˆ°å¥å­ç»“æŸ       â”‚
 â”‚       â”‚       â”œâ”€â”€"ä½ å¥½ã€‚"â”€â”€â†’â”‚       â”‚
 â”‚       â”‚       â”‚       â”œâ”€åˆæˆâ†’â”‚       â”‚
 â”‚       â”‚       â”‚       â”‚   audio.mp3   â”‚
 â”‚       â”‚       â”‚       â”‚       â”œâ”€melâ†’â”‚
 â”‚       â”‚       â”‚       â”‚       â”œç”Ÿæˆâ†’â”‚
 â”‚       â”‚       â”‚       â”‚       â”‚ video.mp4
 â”‚       â”‚       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚       â”‚â†videoâ”€â”¤       â”‚       â”‚       â”‚
 â”‚â†â”€æ’­æ”¾â”€â”¤       â”‚       â”‚       â”‚       â”‚
 â”‚ æ•°å­—äººè¯´è¯     â”‚       â”‚       â”‚       â”‚
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. CPU ä¼˜åŒ–ç­–ç•¥

#### INT8 é‡åŒ–
```python
# Whisper ä½¿ç”¨ int8 é‡åŒ–
model = WhisperModel(
    "small",
    compute_type="int8"  # FP32 â†’ INT8
)

æ€§èƒ½æå‡ï¼š
- é€Ÿåº¦ï¼š3-4å€
- å†…å­˜ï¼šå‡å°‘ 75%
- ç²¾åº¦æŸå¤±ï¼š<2%
```

#### ONNX Runtime ä¼˜åŒ–
```python
sess_options = ort.SessionOptions()
sess_options.intra_op_num_threads = 4      # çº¿ç¨‹æ•°
sess_options.execution_mode = ORT_PARALLEL # å¹¶è¡Œæ‰§è¡Œ
sess_options.graph_optimization_level = ORT_ENABLE_ALL

ä¼˜åŒ–æ•ˆæœï¼š
- æ¨ç†é€Ÿåº¦æå‡ 2-3å€
- å†…å­˜ä½¿ç”¨å‡å°‘ 30%
```

#### NumPy å‘é‡åŒ–
```python
# âŒ æ…¢ï¼šå¾ªç¯å¤„ç†
for i in range(len(frames)):
    frames[i] = frames[i] / 255.0

# âœ… å¿«ï¼šå‘é‡åŒ–æ“ä½œ
frames = frames / 255.0

æ€§èƒ½å·®è·ï¼š10-100å€
```

### 2. å†…å­˜ç®¡ç†

#### å¼•ç”¨è®¡æ•°ä¸åƒåœ¾å›æ”¶
```python
def release(self):
    # 1. æ¸…é™¤ Handler å¼•ç”¨
    self.vad_handler = None
    self.asr_handler = None
    self.llm_handler = None
    
    # 2. æ¸…ç©ºç¼“å†²åŒº
    self.audio_buffer.clear()
    self.conversation_history.clear()
    
    # 3. å¼ºåˆ¶åƒåœ¾å›æ”¶
    import gc
    gc.collect()
```

#### å†…å­˜ç›‘æ§
```python
import psutil

process = psutil.Process()
memory_mb = process.memory_info().rss / 1024 / 1024

if memory_mb > MAX_MEMORY:
    # æ¸…ç†æ—§ä¼šè¯
    cleanup_old_sessions()
```

### 3. å¼‚æ­¥ç¼–ç¨‹

#### asyncio äº‹ä»¶å¾ªç¯
```python
# å¹¶å‘å¤„ç†å¤šä¸ªå¥å­
tasks = []
for sentence in sentences:
    task = asyncio.create_task(
        self._process_sentence(sentence, callback)
    )
    tasks.append(task)

# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
await asyncio.gather(*tasks)
```

#### å¼‚æ­¥ç”Ÿæˆå™¨
```python
async def stream_response(self, text):
    stream = await self.client.chat.completions.create(
        messages=[{"role": "user", "content": text}],
        stream=True
    )
    
    async for chunk in stream:
        if chunk.choices[0].delta.content:
            yield chunk.choices[0].delta.content
```

### 4. é”™è¯¯å¤„ç†

#### åˆ†å±‚é”™è¯¯å¤„ç†
```python
try:
    # ä¸šåŠ¡é€»è¾‘
    result = await handler.process(data)
except ModelLoadError:
    # æ¨¡å‹åŠ è½½å¤±è´¥ - é‡è¯•
    await handler.reload()
except ProcessingError as e:
    # å¤„ç†é”™è¯¯ - é™çº§
    logger.error(f"Processing failed: {e}")
    return fallback_result
except Exception as e:
    # æœªçŸ¥é”™è¯¯ - ä¸ŠæŠ¥
    logger.exception("Unexpected error")
    metrics.record_error(type(e).__name__)
    raise
```

#### è¶…æ—¶æ§åˆ¶
```python
import asyncio

try:
    result = await asyncio.wait_for(
        long_running_task(),
        timeout=30.0  # 30ç§’è¶…æ—¶
    )
except asyncio.TimeoutError:
    logger.warning("Task timeout")
    # æ¸…ç†èµ„æº
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å»¶è¿ŸåŠ è½½

```python
class Session:
    async def initialize_handlers(self):
        # ä»…åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶åŠ è½½æ¨¡å‹
        if not self.asr_handler:
            self.asr_handler = WhisperHandler()
            await self.asr_handler.initialize()
```

### 2. ç¼“å­˜ç­–ç•¥

```python
# å¯¹è¯å†å²ç¼“å­˜
@lru_cache(maxsize=128)
def get_conversation_context(session_id: str) -> List[dict]:
    return load_from_redis(session_id)

# æ¨¡å‹ç¼“å­˜
_model_cache = {}

def get_model(model_name: str):
    if model_name not in _model_cache:
        _model_cache[model_name] = load_model(model_name)
    return _model_cache[model_name]
```

### 3. æ‰¹å¤„ç†

```python
# æ‰¹é‡å¤„ç†è§†é¢‘å¸§
batch_size = 5
for i in range(0, len(mel_chunks), batch_size):
    batch = mel_chunks[i:i+batch_size]
    results = await process_batch(batch)  # å¹¶è¡Œå¤„ç†
```

### 4. è¿æ¥æ± 

```python
# HTTP è¿æ¥æ± 
import httpx

async with httpx.AsyncClient(
    limits=httpx.Limits(
        max_connections=100,
        max_keepalive_connections=20
    )
) as client:
    response = await client.post(url, json=data)
```

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡** - Handler æ¨¡å¼æ˜“äºæ‰©å±•
2. **æ€§èƒ½ä¼˜åŒ–** - CPU ä¸“é—¨ä¼˜åŒ–ï¼Œæ— éœ€ GPU
3. **å®æ—¶å“åº”** - æµå¼å¤„ç†é™ä½å»¶è¿Ÿ 70%
4. **èµ„æºæ§åˆ¶** - æ™ºèƒ½å†…å­˜ç®¡ç†å’Œä¼šè¯æ§åˆ¶
5. **å¯è§‚æµ‹æ€§** - Prometheus ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### æŠ€æœ¯äº®ç‚¹

1. **æµå¼æ¶æ„** - è¾¹ç”Ÿæˆè¾¹æ’­æ”¾
2. **ONNX åŠ é€Ÿ** - Wav2Lip CPU ä¼˜åŒ–
3. **FFmpeg ç¼–ç ** - è§†é¢‘ä½“ç§¯å‡å°‘ 96%
4. **WebSocket åŒåè®®** - JSON + Binary
5. **Handler æ¨¡å¼** - ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºç»´æŠ¤

### é€‚ç”¨åœºæ™¯

- âœ… å®¢æœæœºå™¨äºº
- âœ… è™šæ‹Ÿä¸»æ’­
- âœ… æ•™è‚²åŸ¹è®­
- âœ… æ™ºèƒ½åŠ©æ‰‹
- âœ… æ— éšœç¢è¾…åŠ©

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1.0  
**æœ€åæ›´æ–°**: 2024-10-16  
**ç»´æŠ¤è€…**: Lightweight Avatar Chat Team

